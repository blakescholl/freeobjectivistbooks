<% content_for :stylesheet do %>
<style>
.request, .pledge, .actions {
    margin-top: 8px;
    margin-bottom: 8px;
}

.multiple-books {
    margin-top: 20px;
}

.name {
    margin-bottom: 0;
}

.notes {
    margin-top: 12px;
}

.button, .loading {
    height: 46px;
    margin-bottom: 6px;
    background-position-x: left;
}

.actions p {
    padding-left: 3px;
}

.sent {
    background-image: url(/assets/sent-button.png);
}

.any-donations {
    display: <%= @donations.any? ? "block" : "none" %>;
}

.no-donations {
    display: <%= @donations.any? ? "none" : "block" %>;
}
</style>
<% end %>

<h1 class="grid_16"><%= @current_user.name %></h1>

<div class="grid_12">
    <% if @current_user.requests.any? %>
    <h2>Your request</h2>
    <% @current_user.requests.each do |request| %>
    <div class="request">
        <p class="headline"><%= request.user.name %> wants to read <span class="title"><%= request.book %></span></p>

        <p class="status">
            <% if request.sent? %>
            <%= request.donor.name %> in <%= request.donor.location %> has sent this book.
            <% elsif request.granted? %>
            We have found you a donor! <%= request.donor.name %> in <%= request.donor.location %>.
            <% else %>
            We are looking for a donor for you. We'll let you know when we find someone.
            <% end %>
        </p>

        <% if request.address.blank? %>
            <% if request.flagged? %>
            <p class="flagged">We need your address to send you your book.</p>
            <% end %>
        <p><%= link_to 'Add your address', edit_request_path(request) %></p>
        <% elsif request.flagged? %>
        <p class="flagged">There seems to be a problem with your shipping info.</p>
        <p><%= link_to 'Update your shipping info', edit_request_path(request) %></p>
        <% elsif request.granted? %>
        <p>They will send your book soon.</p>
            <% if request.needs_thanks? %>
            <p><%= link_to "Thank #{request.donor.name}", edit_request_path(request, type: "thank") %></p>
            <% end %>
        <% end %>

        <p><%= link_to 'See full request details', request_path(request) %></p>
    </div>
    <% end %>
    <p class="multiple-books">Want another book? <%= mail_to 'jason@rationalegoist.com', 'Contact Jason' %>
    <% end %>

    <% if @current_user.pledges.any? %>
    <% @current_user.pledges.each do |pledge| %>
    <div class="pledge">
        <p class="headline">You pledged to donate <%= pledge.quantity %> books</p>
    </div>
    <% end %>
    <% end %>

    <% if @show_donations %>
    <h2>Outstanding donations</h2>
        <div class="any-donations">
            <p>Please send the following books:</p>
            <%= render partial: "donation", collection: @donations %>
            <%= render "donation_notes" %>
        </div>
        <p class="no-donations">None right now.</p>
        <% if @flag_count > 0 %>
        <p class="flagged"><%= pluralize @flag_count, 'donation' %> flagged and waiting on student response.</p>
        <% end %>
    <p><%= link_to 'Find students to donate books to', donate_path %></p>
    <p><%= link_to 'See all your donations', donations_path %></p>
    <% end %>
</div>
<div class="clear"></div>

<% content_for :javascript do %>
<script>
$(document).ready(function () {
    $('div.donation').handleAjax(function () {
        if ($('div.donation:visible').size() === 1) {
            $('.any-donations').animate({height: 'toggle', opacity: 'toggle'}, {duration: 600});
            $('.no-donations').animate({height: 'toggle', opacity: 'toggle'}, {duration: 600});
        } else {
            $(this).animate({height: 'toggle', opacity: 'toggle'}, {duration: 600});
        }
    });
});
</script>
<% end %>
